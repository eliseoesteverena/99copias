<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Test RLS</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}body{font-family:sans-serif;background:#667eea;padding:10px}.container{max-width:600px;margin:0 auto}.card{background:#fff;border-radius:8px;padding:15px;margin-bottom:10px;box-shadow:0 4px 12px rgba(0,0,0,.15)}h1{font-size:20px;margin-bottom:10px;color:#333}input,button{width:100%;padding:10px;margin:5px 0;border-radius:6px;border:1px solid #ddd;font-size:14px}button{background:#667eea;color:#fff;border:none;cursor:pointer;font-weight:600}button:active{background:#5568d3}.btn-test{background:#4caf50;margin-top:5px}.btn-danger{background:#f44336}.result{background:#f5f5f5;padding:10px;border-radius:6px;margin-top:10px;font-family:monospace;font-size:12px;white-space:pre-wrap;max-height:400px;overflow-y:auto}.error{color:#c62828;background:#ffebee;padding:8px;border-radius:4px;margin-top:5px;font-size:13px}.success{color:#388e3c;background:#e8f5e9;padding:8px;border-radius:4px;margin-top:5px;font-size:13px}.hidden{display:none}.info{background:#e3f2fd;padding:8px;border-radius:4px;margin:5px 0;font-size:12px}
</style>
</head>
<body>
<div class="container">
<div class="card" id="login">
<h1>ğŸ” Test RLS</h1>
<input type="email" id="email" placeholder="Email" required>
<input type="password" id="pwd" placeholder="ContraseÃ±a" required>
<button onclick="login()">Login</button>
<div id="loginErr" class="error hidden"></div>
</div>
<div class="card hidden" id="tests">
<h1>Tests RLS</h1>
<div class="info">Email: <span id="userEmail"></span></div>
<button class="btn-test" onclick="test1()">Test 1: Ver mis datos (SELECT)</button>
<button class="btn-test" onclick="test2()">Test 2: Insertar en otro grupo</button>
<button class="btn-test" onclick="test3()">Test 3: Cambiar mi rol</button>
<button class="btn-test" onclick="testAll()">ğŸš€ Ejecutar Todo</button>
<div id="results" class="hidden"><div class="result" id="output"></div></div>
<button class="btn-danger" onclick="logout()">Salir</button>
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
<script>
const URL='https://vkthaoiurwuzuztpvuyl.supabase.co';
const KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZrdGhhb2l1cnd1enV6dHB2dXlsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwODM3MDksImV4cCI6MjA4MjY1OTcwOX0.GfQWCwW4I_PeHijgafPhBmBAlS2lqT8aw9UaIY8TdXY';
var sb=window.supabase.createClient(URL,KEY);
var u=null;
function show(id){document.getElementById(id).classList.remove('hidden')}
function hide(id){document.getElementById(id).classList.add('hidden')}
function log(txt){document.getElementById('output').textContent+=txt+'\n\n';show('results')}
async function login(){
let e=document.getElementById('email').value;
let p=document.getElementById('pwd').value;
let err=document.getElementById('loginErr');
hide('loginErr');
try{
let {data,error}=await sb.auth.signInWithPassword({email:e,password:p});
if(error)throw error;
u=data.user;
document.getElementById('userEmail').textContent=u.email;
hide('login');show('tests');
}catch(ex){
err.textContent='âŒ '+ex.message;
show('loginErr');
}}
async function logout(){
await sb.auth.signOut();
u=null;
hide('tests');show('login');
hide('results');
document.getElementById('email').value='';
document.getElementById('pwd').value='';
}
async function test1(){
document.getElementById('output').textContent='â³ Test 1: SELECT datos...\n\n';
show('results');
try{
let queries=[
sb.from('clientes').select('*',{count:'exact',head:true}),
sb.from('empresas').select('*',{count:'exact',head:true}),
sb.from('trabajos').select('*',{count:'exact',head:true})
];
let results=await Promise.all(queries);
log('âœ… TEST 1: Ver mis datos\n'+
'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n'+
'Clientes: '+(results[0].count||0)+'\n'+
'Empresas: '+(results[1].count||0)+'\n'+
'Trabajos: '+(results[2].count||0)+'\n'+
'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n'+
'âœ… Solo ves datos de TU grupo');
}catch(ex){
log('âŒ ERROR Test 1:\n'+ex.message+'\n\nDetalles:\n'+JSON.stringify(ex,null,2));
}}
async function test2(){
document.getElementById('output').textContent='â³ Test 2: INSERT otro grupo...\n\n';
show('results');
try{
let {data,error}=await sb.from('clientes').insert({
nombre:'Hacker',
apellido:'Test',
email:'test@hack.com',
grupo_id:'00000000-0000-0000-0000-000000000000'
});
if(error)throw error;
log('âŒ TEST 2 FALLÃ“\n'+
'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n'+
'âš ï¸ RLS NO estÃ¡ funcionando\n'+
'Se insertÃ³ en otro grupo\n'+
'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
}catch(ex){
if(ex.message.includes('policy')||ex.message.includes('permission')||ex.code==='42501'){
log('âœ… TEST 2: Insertar en otro grupo\n'+
'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n'+
'âœ… RLS funcionando correctamente\n'+
'Error esperado: '+ex.message+'\n'+
'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
}else{
log('âŒ ERROR Test 2:\n'+ex.message+'\n\nDetalles:\n'+JSON.stringify(ex,null,2));
}}}
async function test3(){
document.getElementById('output').textContent='â³ Test 3: UPDATE rol...\n\n';
show('results');
try{
let {data,error}=await sb.from('perfiles').update({rol:'admin'}).eq('id',u.id);
if(error)throw error;
if(!data||data.length===0){
log('âœ… TEST 3: Cambiar rol\n'+
'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n'+
'âœ… RLS funcionando correctamente\n'+
'No se actualizÃ³ ningÃºn registro\n'+
'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
}else{
log('âŒ TEST 3 FALLÃ“\n'+
'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n'+
'âš ï¸ RLS NO estÃ¡ funcionando\n'+
'Se cambiÃ³ el rol\n'+
'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
}}catch(ex){
if(ex.message.includes('policy')||ex.message.includes('permission')||ex.code==='42501'){
log('âœ… TEST 3: Cambiar rol\n'+
'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n'+
'âœ… RLS funcionando correctamente\n'+
'Error esperado: '+ex.message+'\n'+
'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
}else{
log('âŒ ERROR Test 3:\n'+ex.message+'\n\nDetalles:\n'+JSON.stringify(ex,null,2));
}}}
async function testAll(){
document.getElementById('output').textContent='â³ Ejecutando todos los tests...\n\n';
show('results');
await test1();
await test2();
await test3();
log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n'+
'âœ… TESTS COMPLETADOS\n'+
'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
}
</script>
</body>
</html>